<!DOCTYPE html>
<html><head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 70% }
      body { height: 70%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
    <!-- >script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=GOOGLE_MAPS_API_KEY&sensor=false&libraries=visualizatio">
    </script-->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=GOOGLE_MAPS_API_KEY&libraries=visualization&callback=initMap">
    </script>
    <script type="text/javascript">
    var reading = 0;
    var map,heatmap;
	var heatmapData = [];
    var marker;
    var markers = new Array(100);
    var markerPos = 1;
    var heartRates = new Array (100);
    var heartRatePos = 1;
    var lastLong = 0;
    var lastLat = 0;
    var addition = 0;
    var flip = 0;
    var color;
    // for canvas
    var width = 300;
    var height = 150
    var pixelSize = 1;
    var prev = new Array(45000);
    //var next = new Array(600);

    //center: new google.maps.LatLng(45.397,  -75),
    //var history = {};
     var diff = 0.0;
      function initialize() {
  /*      var mapOptions = {
          
          zoom: 15,
          center: {lat: 37.775, lng: -122.434},
          mapTypeId: google.maps.MapTypeId.SATELLITE
        };
        map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);
        heatmap = new google.maps.visualization.HeatmapLayer({
            data: getPoints(),
            map: map
          });
        var gradient = [
                        'rgba(0, 255, 255, 0)',
                        'rgba(0, 255, 255, 1)',
                        'rgba(0, 191, 255, 1)',
                        'rgba(0, 127, 255, 1)',
                        'rgba(0, 63, 255, 1)',
                        'rgba(0, 0, 255, 1)',
                        'rgba(0, 0, 223, 1)',
                        'rgba(0, 0, 191, 1)',
                        'rgba(0, 0, 159, 1)',
                        'rgba(0, 0, 127, 1)',
                        'rgba(63, 0, 91, 1)',
                        'rgba(127, 0, 63, 1)',
                        'rgba(191, 0, 31, 1)',
                        'rgba(255, 0, 0, 1)'
                      ]
       heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
      */}
      //google.maps.event.addDomListener(window, 'load', initialize);
    </script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script>
//$(document).ready(function(){
//  $("button").click(function(){
//    $.ajax({url:"/logger/rest/read/json/latest/201403",success:function(result){
//      $("#div1").html("<h3>" + result.tsStop + "</h3>");
//    }});
//  });
//});

 // display flags

 var aURL;
 var flicker = new Array();
 // Timer variables
 var timers = new Array();
 var timerStateArray = new Array();
 var ajax = new Array();
 var i = 1;
 //for (i=0;i<<2;i=i+1) {
     timerStateArray[i] = 0;
     //ajax[i] = new Ajax();
     //ajax[i].complete = AjaxUpdateEvent;
     flicker[i] = 0;
 //}
 
 // Base case: Switch the timer flag and call the main loop
 function doTimer(cell,speed,htmlDOMelementId) {

    //aURL = "/logger/rest/read/json/latest/201403";
    //alert("a");
//     if(!timerStateArray[cell]) {
//        timerStateArray[cell] = 1;
          timedCall(cell,speed,htmlDOMelementId);
//     }
 }
 // Main timing loop calls itself
 // 127.0.0.1:7001/logger/FrontController?action=setGps&u=2&lg=-75.940446&lt=45.343883&up=3604
 function timedCall(cell,speed,htmlDOMelementId) {
    var hr1, hr2;
    if(flip > 0) {
        flip = 0;
        color = '#FF0033';
    } else {
        flip = 1;
        color = '#3333ff';
    }
    
    //alert(document.getElementById("ident").value);
    //aURL = "rest/read/json/latest/" + document.getElementById("ident").value;
    aURL = "api/latest?user=" + document.getElementById("ident").value;
    //aURL = "FrontController?action=latest&u=" + document.getElementById("ident").value;
     //ajax[cell].call(url,htmlDOMelementId);
     
     $.ajax({
    	 url: aURL,
    	 success: function(result) {
            console.log(result);
            //{ "tsStop" : 1728163954905, "tsStart" : 1728163954845, "sendSeq" : 10, "recvSeq" : 1, "heartRate1" : null, "heartRate2" : null, "longitude" : -122.406417, "lattitude" : 37.785834}
        hr1 = result.heartRate1;
        hr2 = result.heartRate2;
      $("#div1").html("r:" + result.sendSeq + ",s:" + result.recvSeq + ",hr1:" + hr1 + ",hr2:" + hr2
      + "," + result.lattitude + "," + result.longitude + "," + (result.tsStop - result.tsStart) + "");
      $("#divhr1").html("<b><h2><font style=\"{font-color:#ff0055%; font-height:400%}\">" + hr1 + 
      "</font></b> : <font style=\"{font-size:700%}\">" + hr2 + "</font></h2>");
     
      //alert(document.getElementById("ident").value);
      //alert(result);
      
      if(reading > 1) {
        
        addPolyLine(map, parseFloat(lastLat + addition), parseFloat(lastLong + addition), 
        parseFloat(result.lattitude), parseFloat(result.longitude),
        color,3);
      } else {
        reading++;
      }
      //addition+=0.1;
      lastLat = result.lattitude;
      lastLong = result.longitude;
      
      var aLatLng = new google.maps.LatLng(result.lattitude, (result.longitude + diff));
      //marker = new google.maps.Marker({
        //position: aLatLng,
        //map: map,
        //title: result.heartRate1 + ":" + result.heartRate2
        //});
        
      //var map = new google.maps.Map(document.getElementById("map-canvas"));
      //map.setZoom(15);
      //diff = diff + 0.001;
      map.setCenter(aLatLng);
      
        display();
        shiftRight();//copy();

        //var example = document.getElementById('minigraph');
        //var context = example.getContext('2d');
        //context.fillStyle = "rgb(128,255,10)";
        //context.fillRect(100,0, 10,10);
        var i=0;
        var hr = height - (parseInt(result.heartRate1) - 50);
        prev[height * width + width - 2] = 1;
        prev[height * width - 2] = 1;
        i = hr;
        ///for(i=height-1;i>hr;i--) { // vertical line at x=width
            prev[i * width + width - 2] = 2;
        //}

    } // success
    , cache: false
    }); // ajax
    
 
 //     if(timerStateArray[cell]) {
           timers[cell] = setTimeout(function() { timedCall(cell,speed,htmlDOMelementId); }, speed); // no speed = max speed
//     }
 }
    
    function addPolyLine(aMap, lat0, long0, lat1, long1, color, weight) {
        //alert(lat0)
        var flightPlanCoordinates = [
        new google.maps.LatLng(lat0, long0),new google.maps.LatLng(lat1, long1)];

        flightPath = new google.maps.Polyline({
            path: flightPlanCoordinates,
            strokeColor: color,//'#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: weight
        });
        flightPath.setMap(map);
        //alert(lat1);
    }
    
    function shiftRight() {
        var x=0;
        var y=0;
        var offset = 0;
        for(x=0;x<width;x++) {
            
            for(y=1;y<height;y++) {
            offset = y * width;
                prev[offset+x-1] = prev[offset + x];
            }
        }
    }
    
    function copy() {
        var x=0;
        var y=0;
        var offset = 0;
        for(y=0;y<height;y++) {
            offset = y * width;
            for(x=1;x<width;x++) {
                prev[offset+x-width] = 1-next[offset + x];
            }
        }
    }
    
    function display() {
        var example = document.getElementById('minigraph');
        var context = example.getContext('2d');
        var x=0;
        var y=0;
        var offset = 0;
        var yPixel = 0;
        var cOffset = 0;
        for(y=0;y<height;y++) {
            offset = y * width;
            yPixel = y * pixelSize;
            for(x=0;x<width;x++) {
                cOffset = offset + x;
                if(prev[cOffset] > 0) {
                    if(prev[cOffset] > 2) {
                    context.fillStyle = "rgb(192,32,64)";
                    } else {
                    context.fillStyle = "rgb(8,192,64)";
                    }
                } else {
                    context.fillStyle = "rgb(255,255,255)";
                }               
                context.fillRect(x * pixelSize, yPixel, pixelSize, pixelSize);
            }
        }
    }
    

 
 
    function load() {
        var x=0;
        var y=0;
        var offset = 0;
        for(y=0;y<height;y++) {
            offset = y * width
            for(x=0;x<width;x++) {
                prev[offset + x] = 0;
                //next[offset + x] = 1;
            }
        }
        var example = document.getElementById('minigraph');
        var context = example.getContext('2d');
        context.fillStyle = "rgb(255,255,255)";
        context.fillRect(0, 0, width * pixelSize, height * pixelSize);
        
        //aURL = "FrontController?action=activeid";
        aURL = "api/activeId";
        //ajax[cell].call(url,htmlDOMelementId);
        document.getElementById("ident").innerHTML='searching...';
        $.ajax({
        	url:aURL,
        	success:function(result) {
        	document.getElementById("ident").value=result.id;
        	console.log(result); //{ "id" : "20241005" }
            console.log(result.id); //undefined if , produces = MediaType.APPLICATION_JSON_VALUE not set in spring boot api
         //$("#ident").html("r:" + result.sendSeq + ",s:" + result.recvSeq + ",hr1:" + hr1 + ",hr2:" + hr2
         //+ "," + result.lattitude + "," + result.longitude + "," + (result.tsStop - result.tsStart) + "");
         
         doTimer(1,500,2);
		 loadHeatmap(201611185);//result.id);
         //alert(document.getElementById("ident").value);

            //document.getElementById("ident_message").innerHTML=' latest';
            
       }}); // ajax
       
    }
    
	function loadHeatmap(userId) {
	    $.ajax({
	        url: "coordinates/" + userId,
	        success: function(result) {
	            heatmapData = result.map(function(p) {
	                return new google.maps.LatLng(p.lattitude, p.longitude);
	            });
	            if(heatmap) {
	                heatmap.setData(heatmapData);
	            }
	        }
	    });
	}
    
    var map, heatmap;

    function initMap() {
      map = new google.maps.Map(document.getElementById('map-canvas'), {
        zoom: 14,
        //center: {lat: 37.775, lng: -122.434},
        center: {lat: 45.429101, lng: -75.69723},
        mapTypeId: google.maps.MapTypeId.SATELLITE
      });

      heatmap = new google.maps.visualization.HeatmapLayer({
        data: heatmapData(),
        map: map
      });
    }

    function toggleHeatmap() {
      heatmap.setMap(heatmap.getMap() ? null : map);
    }

    function changeGradient() {
      var gradient = [
        'rgba(0, 255, 255, 0)',
        'rgba(0, 255, 255, 1)',
        'rgba(0, 191, 255, 1)',
        'rgba(0, 127, 255, 1)',
        'rgba(0, 63, 255, 1)',
        'rgba(0, 0, 255, 1)',
        'rgba(0, 0, 223, 1)',
        'rgba(0, 0, 191, 1)',
        'rgba(0, 0, 159, 1)',
        'rgba(0, 0, 127, 1)',
        'rgba(63, 0, 91, 1)',
        'rgba(127, 0, 63, 1)',
        'rgba(191, 0, 31, 1)',
        'rgba(255, 0, 0, 1)'
      ]
      heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
    }

    function changeRadius() {
      heatmap.set('radius', heatmap.get('radius') ? null : 20);
    }

    function changeOpacity() {
      heatmap.set('opacity', heatmap.get('opacity') ? null : 0.2);
    }

	
	// Heatmap data loaded via AJAX
	function getPoints() {
	    return heatmapData;
	}
	
    // Heatmap data: 500 Points
    function getPointsOld() {
      return [ // 4331 points from 201611185 
               // select DISTINCT LATITUDE, LONGITUDE from biometric.gps_record r where r.userId like '201611185'
                new google.maps.LatLng(45.43404    , -75.692262
                ), new google.maps.LatLng(45.433999   , -75.692268
                ), new google.maps.LatLng(45.433987   , -75.692271
                ), new google.maps.LatLng(45.433733   , -75.692286)
        
      ];
    }
</script>
<script type="text/javascript"><!--
google_ad_client = "ca-pub-9638874893594007";
/* gps_add_728_90 */
google_ad_slot = "9413214396";
/* objectivej_728_90 */
//google_ad_slot = "9016261595";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<!-- script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script-->
</head>
<body onload="javascript:load();">

<div id="div1"></div><button onclick=doTimer(1,500,2)>Track</button>
<textarea id="ident" rows=1 cols=14></textarea><!-- p id="ident_message"></p--><br/>
<div id="divhr1"></div><!--div id="divhr2"></div-->

<canvas id="minigraph" width=300 height=150></canvas>
<div id="map-canvas" ></div>
<p>obrienlabs:20241003 - rel 1.0.1</p>
</body>
</html>
